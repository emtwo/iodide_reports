<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>untitled - iodide</title>
<link rel="stylesheet" type="text/css" href="https://iodide.io/master/iodide.master.css">
</head>
<body>
<script id="jsmd" type="text/jsmd">
%% meta
{
  "lastSaved": "2018-06-20T18:43:36.236Z",
  "lastExport": "2018-06-20T18:43:57.752Z"
}

%% resource
https://d3js.org/d3-dsv.v1.min.js
https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js
https://cdnjs.cloudflare.com/ajax/libs/plotly.js/1.36.1/plotly.min.js

%% js
// External Variables
API_KEY = "TCESKtblLVKKlbJVXKjvwlYwGOqZrgmeu1YYFuri"
SQL_QUERY = "SELECT * FROM experiments LIMIT 5"

%% js
var files = {
  'graphs/population_size.csv': {
    x: 'submission_date', group: 'type', y: 'count', id: '0', 'ylabel': 'User Count', width: 1600
  },
  'graphs/[Existing_Users]_Average_navigation_about_newtab_Per_Active_Hour_Per_User.csv': {
    x: 'date', group: 'type', y: '_col2', err: 'err', id: '1', 'ylabel': 'Events Per Active Hour', width: 800
  },
  'graphs/[New_Users]_Average_unfiltered_uri_count_Per_Active_Hour_Per_User.csv': {
    x: 'date', group: 'type', y: 'avg', err: '_col3', 'id': '2', 'ylabel': 'Events Per Active Hour', width: 800
  },
  'graphs/[Existing_Users]_Average_navigation_searchbar_per_active_hour_per_user.csv': {
    x: 'date', group: 'type', y: '_col2', err: 'err', 'id': '3', 'ylabel': 'Events Per Active Hour', width: 800
  },
  'graphs/[New_Users]_Average_unique_domains_count_per_active_hour_per_user.csv': {
    x: 'date', group: 'type', y: 'avg', err: '_col3', 'id': '4', 'ylabel': 'Events Per Active Hour', width: 800
  },
};

%% js
function getTitleFromFilename(filename) {
  var unstripped = filename.substring(filename.indexOf('/') + 1, filename.indexOf('.'));
  var title = unstripped.replace(/_/g, " ");
  return title;
}

%% js
function dynamicSort(property) {
  return function compareRows(a, b) {
    if (a[property] < b[property])
      return -1;
    if (a[property] > b[property])
      return 1;
    return 0;
  };
}

%% js
function transformX(xVal) {
  if (!isNaN(xVal) && String(xVal).length === 8) {
    xVal = xVal.slice(0, 4) + '-' + xVal.slice(4, 6) + '-' + xVal.slice(6);
  }
  return xVal;
}

%% js
function createTraces(csvFile, fileInfo) {
  // ---1--- Sort files rows based on x-axis so the line graphs look correct.
  var csvRows = [];
  for (var row of csvFile) {
    csvRows.push(row);
  }
  csvRows.sort(dynamicSort(fileInfo.x));
  
 
  // ---2--- Trace info split by group.
  var xVals = {};
  var yVals = {};
  var err = {};
  for (var row of csvRows) {
    var groupName = 'default';
    if ('group' in fileInfo) {
      groupName = row[fileInfo.group];
    }
    // If the group doesn't exist in one of the types of values,
    // it doesn't exist in any of them.
    if (!(groupName in xVals)) {
      xVals[groupName] = [];
      yVals[groupName] = [];
      err[groupName] = [];
    }
    var transformedX = transformX(row[fileInfo.x]);
    xVals[groupName].push(transformedX);
    yVals[groupName].push(row[fileInfo.y]);
    if (fileInfo.err) {
      err[groupName].push(row[fileInfo.err]);
    }
  }
  
  // ---3--- Create traces to be returned
  var traces = [];
  for (var groupName in xVals) {
    var trace = {
    	x: xVals[groupName],
      	y: yVals[groupName],
      	xaxis: 'x' + fileInfo.id,
      	yaxis: 'y' + fileInfo.id,
      	name: groupName,
    };
    if (Object.keys(err).length > 0) {
      trace["error_y"] = {
        array: err[groupName]
      }
    }
    traces.push(trace);
  }
  return traces;
}

%% js
function createLayouts(graphInfo) {
  var layouts = {
    title: graphInfo.title,
    width: graphInfo.width,
  };
  layouts["yaxis" + graphInfo.id] = {
    title: graphInfo.ylabel
  }
  return layouts;
}

%% js
var csvFiles = [];
for (var fileName in files) {  
  fetch(fileName)
    .then(d => {
    	var urlStart = d.url.indexOf('graphs');
    	var filename = d.url.substring(urlStart);
    	var title = getTitleFromFilename(filename);
    	return Promise.all([d.text(), filename, title]);
  	})
    .then(d => {
		var fileInfo = files[d[1]];
    	fileInfo["title"] = d[2];
    	csvFiles.push({file: d[0], fileInfo: fileInfo});
  	})
}

%% md
<div id='graphs' style='max-width: 1600px'></div>

%% js
var domGraphs = "";
var filenames = Object.keys(files);
for (var keyIndex in filenames) {
  var filename = filenames[keyIndex];
  var graphWidth = files[filename].width;
  var div = "<div id='graph" + String(keyIndex) + "' style='max-width: 1600px; float: left; width: " + String(graphWidth) + "px;'></div>";
  domGraphs += div;
}
$( "#graphs" ).append(domGraphs);

%% js
for (var i in csvFiles) {
  var csvFile = csvFiles[i];
  var traces = createTraces(d3.csvParse(csvFile.file), csvFile.fileInfo);
  var layouts = createLayouts(csvFile.fileInfo);
  Plotly.newPlot('graph' + csvFile.fileInfo.id, traces, layouts);
}
</script>
<div id='page'></div>
<script src='https://iodide.io/master/iodide.master.js'></script>
</body>
</html>